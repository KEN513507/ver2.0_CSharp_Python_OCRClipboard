# [質問] 常駐ワーカー実装の仕様確認（PYTHONPATH・起動方式・モデル配置）

**作成日**: 2025年11月1日  
**対象**: ChatGPT (開発AI "g-pWdixegxH-windows-11-whiz/c/68fb95c8-f614-8323-9b08-5619b9d53afb")  
**担当**: Claude (GitHub Copilot)

---

## 背景
現在、PYTHONPATH設定の問題で `ocr_screenshot_app` モジュールが見つからない問題が発覚しました。
`$env:PYTHONPATH=".;src/python;ocr-screenshot-app"` で解決しましたが、常駐ワーカー実装前に仕様を確認したいです。

---

## 診断結果

### ❌ PYTHONPATH未設定時
```pwsh
python -c "from ocr_screenshot_app.ocr import recognize_image; print('OK')"
# ModuleNotFoundError: No module named 'ocr_screenshot_app'

python src/python/ocr_worker/main.py
# ModuleNotFoundError: No module named 'ocr_screenshot_app'
```

### ✅ PYTHONPATH設定後
```pwsh
$env:PYTHONPATH=".;src/python;ocr-screenshot-app"
python -c "from ocr_screenshot_app.ocr import recognize_image; print('OK')"
# OK
```

### ✅ CLI単体実行は正常動作
```pwsh
python ocr-screenshot-app/main.py --image ./test_image.png --no-clipboard
# [INFO] [PERF] preproc=7.4ms infer=87112.8ms postproc=0.2ms total=87120.4ms
# [INFO] [OCR] n_fragments=16 mean_conf=0.97 min_conf=0.77
# {"success": true, "texts": [...]}
```
→ **87秒で完了、OCR成功**（ただし相対importで動作）

---

## 質問事項

### 1. C# 側の PYTHONPATH 設定
**現状**: `PythonProcessHost.cs` は `PYTHONPATH=src/python` のみ設定  
**問題**: `ocr_screenshot_app` モジュールが見つからず、常駐ワーカーが即終了

**質問**: 
- `PYTHONPATH` に `ocr-screenshot-app` も追加する必要がありますか？
- それとも `ocr-screenshot-app/` を `src/python/` 配下に移動させるべきですか？
- 他の解決策がありますか？

---

### 2. 常駐ワーカーの起動方式
README に「常駐ワーカーで初期化コストをゼロに」とありますが、具体的な運用方法が不明です。

**質問**:
- **パターンA**: バックグラウンドサービス（タスクトレイ常駐）として実装しますか？
- **パターンB**: C# アプリ起動時に自動起動・終了時に自動停止ですか？
- **パターンC**: README の「デスクトップアイコンをダブルクリックでウォームアップ」の意図を教えてください。
  - これは別途ランチャーアプリを作成する想定ですか？
  - それとも C# アプリのショートカットを指していますか？
  - ウォームアップ後、ワーカーは常駐し続けますか？それともC#アプリ起動まで待機しますか？

---

### 3. モバイルモデルの配置
**現状**: `PP-OCRv5_server_*`（大モデル）が使われており、初期化に90秒かかっています。

**質問**:
- モバイルモデル（`ppocrv3_mobile_*`）は**手動ダウンロード・配置**する運用ですか？
- 配置先は `C:/models/` 固定で良いですか？（README記載通り）
- 自動ダウンロード機能を実装する予定はありますか？
- モバイルモデルのダウンロード元URLやコマンドを教えてください。
- モバイルモデルに切り替えた場合、精度への影響はどの程度許容できますか？

---

### 4. 実装優先順位
次のどちらを先に進めるべきですか？

**パターンA**: 常駐ワーカーの実装完了
- PYTHONPATH問題の解決
- IPC安定化
- ウォームアップ機能の実装
- C#からの起動確認

**パターンB**: 性能検証
- 現状のserverモデルでループテストを実行
- 2-3秒目標の達成可否を測定
- ボトルネック特定
- その後、常駐ワーカー実装

**推奨**: どちらが効率的ですか？

---

## 現状まとめ

| 項目 | 状態 | 備考 |
|------|------|------|
| PYTHONPATH問題の原因特定 | ✅ 完了 | `ocr-screenshot-app` が未設定 |
| 暫定解決（手動設定） | ✅ 完了 | `$env:PYTHONPATH=".;src/python;ocr-screenshot-app"` |
| CLI単体実行 | ✅ 正常動作 | 87秒、OCR成功、mean_conf=0.97 |
| 常駐ワーカー起動 | ❌ PYTHONPATH未設定で即終了 | ModuleNotFoundError |
| 2回目以降の性能 | ❌ 未測定 | ウォームアップ後の速度不明 |
| C#からの起動 | ❌ 未確認 | IPC統合テスト未実施 |

---

## 追加情報

### pyproject.toml の現状
```toml
[tool.pytest.ini_options]
pythonpath = [".", "src/python", "ocr-screenshot-app"]
```
→ これは **pytest実行時のみ** 有効で、通常のPython実行には適用されません。

### README の記載
> - C#ホストは`PYTHONPATH`を`src/python`に設定し、`ocr_worker`モジュールをimport可能に。

→ `ocr-screenshot-app` が含まれていないため、`ocr_worker/main.py` が `ocr_screenshot_app` をimportできません。

### ディレクトリ構造
```
ver2_0_CSharp_Python_OCRClipboard/
├── src/
│   ├── csharp/
│   │   ├── OCRClipboard.App/
│   │   └── OCRClipboard.Overlay/
│   └── python/
│       └── ocr_worker/          # ← PYTHONPATH=src/python で認識可能
│           ├── __init__.py
│           ├── main.py          # ← ここから ocr_screenshot_app をimport
│           ├── handler.py
│           └── ...
├── ocr-screenshot-app/          # ← PYTHONPATH に含まれていない！
│   ├── main.py
│   └── ocr_screenshot_app/
│       ├── __init__.py
│       ├── ocr.py
│       ├── capture.py
│       └── ...
└── ...
```

---

## 期待する回答

1. **PYTHONPATH設定の正解** を教えてください
   - C#側で `PYTHONPATH=src/python;ocr-screenshot-app` に変更するのが正解？
   - それとも `ocr-screenshot-app/` → `src/python/ocr_screenshot_app/` へ移動？

2. **常駐ワーカーの具体的な起動フロー** を教えてください
   - ユーザー操作 → システムの挙動 → IPC通信 の流れ

3. **モバイルモデルの入手方法** を教えてください
   - ダウンロード元URL、配置コマンド、環境変数設定

4. **次のステップの優先順位** を教えてください
   - 何から着手すべきか、理由とともに

---

## 参考：性能要件（README より）

- **冷スタート（初回起動）**: 90-100秒 → **許容**
- **2回目以降**: 2-3秒 → **必須目標**
- **UX目標**: 範囲指定 → 10秒以内にOCR → クリップボード

**ハードウェア制約**:
- CPU: i7-8550U (4C8T, ~2.0GHz)
- GPU: Intel UHD 620 (iGPU、CUDA非対応)
- モデル: PP-OCRv5_server (1GB+)

---

**以上、回答をお願いします。**
