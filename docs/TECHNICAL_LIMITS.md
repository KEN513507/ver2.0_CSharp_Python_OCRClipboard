# Windows.Media.Ocr 技術的制約と性能限界

## 概要
このドキュメントは Windows.Media.Ocr の実測性能と技術的制約を記録します。

---

## 📊 実測性能データ（2025-11-01時点）

### 処理実績
| 項目 | 実測値 | 備考 |
|------|--------|------|
| 最大フラグメント数 | 60 | 1回の処理で確認 |
| 最大文字数 | 161文字 | 日本語混在テキスト |
| OCR処理時間（60フラグメント） | 306-608ms | テキスト量に比例 |
| OCR処理時間（平均） | 100-400ms | ウォームアップ後 |

### 性能傾向
```
フラグメント数 → OCR時間
15-20個        → 100-150ms
40-60個        → 300-400ms
100個以上      → 未測定（推定 500-800ms）
```

---

## 🔍 Windows.Media.Ocr API 仕様

### 公式ドキュメント制限
- **最大画像サイズ**: 制限なし（メモリ依存）
- **最大テキスト長**: 制限なし（API仕様上）
- **同時処理**: 不可（シングルスレッド推奨）
- **識字率**: **文字数に依存しない**（画像品質とフォント依存）

### 実用上の制約

#### 1. 画像サイズ
- **推奨**: 1920x1080 以下（フルHD）
- **最大**: 3840x2160（4K）まで動作確認済み
- **超過時**: OutOfMemoryException または処理時間 >5秒

#### 2. テキスト密度
- **高密度** (小フォント、行間狭い): 処理時間増加、精度低下
- **低密度** (大フォント、行間広い): 高速・高精度

#### 3. 文字数と処理時間の関係
**重要**: 文字数が増えても**識字率（精度）は変わりません**  
**変わるのは処理時間のみ**

**このプロジェクトの運用基準**（SLA: proc_total < 400ms）:
- **快適**: 200文字以内（<500ms）
- **許容**: 500文字以内（<1000ms）
- **限界**: 1000文字（>2000ms、**時間的に**非推奨）

**ライブラリ（Windows.Media.Ocr）自体の制限**: 
- **文字数上限**: なし
- **識字率低下**: なし（文字数による影響なし）
- **処理時間**: 文字数に比例して増加（線形）

#### 4. 言語混在
- 日本語 + 英数字: 正常動作（実測済み）
- 複数言語同時: 非対応（日本語または英語のみ）

---

## ⚠️ 既知の問題

### 1. 認識精度
**重要**: 精度は**文字数に依存しません**。以下は**画像品質とフォント**による影響です。

| 状況 | 精度 | 対策 |
|------|------|------|
| 標準フォント（メイリオ等） | 95-99% | なし |
| 小フォント（<10pt） | 80-90% | 拡大キャプチャ推奨 |
| 手書き風フォント | 50-70% | 非推奨 |
| 斜体・装飾 | 70-85% | 上下パディング追加済み |

**文字数が1000文字でも精度は変わりません。処理時間が増えるだけです。**

### 2. 下端欠け問題
**症状**: 行の下端が欠けると認識失敗  
**対策**: 上下8pxパディング追加済み（Program.cs）

### 3. 薄すぎる選択
**症状**: 高さ<40px または 幅/高さ>25 で精度低下  
**対策**: 妥当性チェック＋警告表示（実装済み）

---

## 🎯 推奨運用範囲

### SLA基準（このプロジェクト固有の目標）
- **proc_total < 400ms**: 標準運用範囲
- **proc_total < 1000ms**: 許容範囲（大量テキスト）
- **proc_total > 2000ms**: 要改善（**時間的に**非推奨、精度は問題なし）

### 文字数ガイドライン（処理時間ベース）
```
このプロジェクトの運用基準（時間制約のみ、精度は一定）:
  - 短文 (1-50文字):    OCR 50-150ms   → 最適
  - 中文 (50-200文字):  OCR 150-500ms  → 推奨
  - 長文 (200-500文字): OCR 500-1000ms → 許容
  - 超長文 (500文字+):  OCR >1000ms    → 時間的に非推奨（精度は変わらず）

【重要】
- 1000文字でも識字率は変わりません
- 非推奨なのは「処理時間が長い」という理由のみ
- ユーザーが待てるなら何文字でもOK
```

### キャプチャ領域ガイドライン
```
推奨サイズ:
  - 最小: 100x40 px  (1-2行テキスト)
  - 標準: 400x200 px (5-10行テキスト)
  - 最大: 1200x800 px (A4相当、推奨上限)
  - 超過: 1920x1080+ (処理時間増大、非推奨)
```

---

## 📈 スケーラビリティ

### 現在の構成（Windows.Media.Ocr）
- ✅ 軽量・高速（<500ms）
- ✅ GPU不要
- ❌ 大量テキスト非対応（>500文字で遅延）
- ❌ バッチ処理非対応

### 大量テキスト対応が必要な場合
**代替案**:
1. PaddleOCR（Python）: 500-2000ms、GPU推奨
2. Tesseract OCR: 1000-5000ms、精度やや低い
3. Azure Computer Vision API: クラウド依存

**現在の判断**: Windows.Media.Ocrで十分（要件: 短中文OCR）

---

## 🧪 測定方法

### フラグメント数の確認
```bash
dotnet run 2>&1 | Select-String "fragments"
# [OCR結果] fragments=60, confidence=1.00
```

### 処理時間の確認
```bash
dotnet run 2>&1 | Select-String "proc_total"
# [タイミング分析] proc_total=498ms
```

### 文字数の確認
```bash
dotnet run 2>&1 | Select-String "文字数"
# [クリップボード] コピー=True, 文字数=161
```

---

## 📝 更新履歴

- 2025-11-01: 初版作成、実測データ追加（60フラグメント/161文字）
- 今後: 500文字超のストレステスト予定
